{% extends 'base.html' %}

{% block title %}Malware Analysis Results - Web App Penetration Testing Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Malware Analysis Results
                    </h2>
                    <div>
                        <a href="{{ url_for('malware_bp.malware_dashboard') }}" class="btn btn-sm btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left me-1"></i>Back to Malware Dashboard
                        </a>
                        <a href="{{ url_for('reports_bp.view_report', report_id=report.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-alt me-1"></i>Standard Report View
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Executive Summary -->
                <div class="card mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h4 class="mb-0">Executive Summary</h4>
                    </div>
                    <div class="card-body">
                        <p>{{ report.summary }}</p>
                        
                        <!-- Vulnerability Statistics -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5>Findings Breakdown</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Severity</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set severity_counts = report.get_vulnerability_count_by_severity() %}
                                            {% for severity in ['Critical', 'High', 'Medium', 'Low', 'Info'] %}
                                                <tr>
                                                    <td>
                                                        <span class="badge 
                                                            {% if severity == 'Critical' %}bg-danger
                                                            {% elif severity == 'High' %}bg-warning text-dark
                                                            {% elif severity == 'Medium' %}bg-info text-dark
                                                            {% elif severity == 'Low' %}bg-success
                                                            {% else %}bg-secondary{% endif %}">
                                                            {{ severity }}
                                                        </span>
                                                    </td>
                                                    <td>{{ severity_counts.get(severity, 0) }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-active">
                                                <th>Total</th>
                                                <th>{{ report.vulnerabilities.count() }}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Analysis Stage Distribution</h5>
                                <canvas id="stageDistributionChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Findings by Stage -->
                <div class="card mb-4">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h4 class="mb-0">Analysis Findings by Stage</h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-4">The following potential malware indicators were identified across different analysis stages:</p>
                        
                        <!-- Traffic Analysis Stage -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-network-wired me-2"></i>Traffic Analysis Stage
                                    </h5>
                                    <span class="badge bg-info">{{ stages.traffic_analysis|length }} Findings</span>
                                </div>
                            </div>
                            {% if stages.traffic_analysis %}
                                <div class="list-group list-group-flush">
                                    {% for vuln in stages.traffic_analysis %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-check-circle me-2"></i>No issues found in this stage.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Static Analysis Stage -->
                        <div class="card mb-4 border-primary">
                            <div class="card-header bg-primary bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-code me-2"></i>Static Analysis Stage
                                    </h5>
                                    <span class="badge bg-primary">{{ stages.static_analysis|length }} Findings</span>
                                </div>
                            </div>
                            {% if stages.static_analysis %}
                                <div class="list-group list-group-flush">
                                    {% for vuln in stages.static_analysis %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-check-circle me-2"></i>No issues found in this stage.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Communication Analysis Stage -->
                        <div class="card mb-4 border-warning">
                            <div class="card-header bg-warning bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-exchange-alt me-2"></i>Communication Analysis Stage
                                    </h5>
                                    <span class="badge bg-warning text-dark">{{ stages.communication_analysis|length }} Findings</span>
                                </div>
                            </div>
                            {% if stages.communication_analysis %}
                                <div class="list-group list-group-flush">
                                    {% for vuln in stages.communication_analysis %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-check-circle me-2"></i>No issues found in this stage.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Dynamic Analysis Stage -->
                        <div class="card mb-4 border-danger">
                            <div class="card-header bg-danger bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-play-circle me-2"></i>Dynamic Analysis Stage
                                    </h5>
                                    <span class="badge bg-danger">{{ stages.dynamic_analysis|length }} Findings</span>
                                </div>
                            </div>
                            {% if stages.dynamic_analysis %}
                                <div class="list-group list-group-flush">
                                    {% for vuln in stages.dynamic_analysis %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No dynamic analysis performed or no issues found in this stage.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Selective Dynamic Analysis Stage -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-microscope me-2"></i>Selective Dynamic Analysis
                                    </h5>
                                    <span class="badge bg-success">{{ stages.selective_dynamic|length }} Findings</span>
                                </div>
                            </div>
                            {% if stages.selective_dynamic %}
                                <div class="list-group list-group-flush">
                                    {% for vuln in stages.selective_dynamic %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No selective dynamic analysis performed or no issues found in this stage.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Other Findings -->
                        {% if other_vulnerabilities %}
                            <div class="card mb-4 border-secondary">
                                <div class="card-header bg-secondary bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Other Findings
                                        </h5>
                                        <span class="badge bg-secondary">{{ other_vulnerabilities|length }} Findings</span>
                                    </div>
                                </div>
                                <div class="list-group list-group-flush">
                                    {% for vuln in other_vulnerabilities %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ vuln.type }}</h5>
                                                <span class="badge 
                                                    {% if vuln.severity == 'Critical' %}bg-danger
                                                    {% elif vuln.severity == 'High' %}bg-warning text-dark
                                                    {% elif vuln.severity == 'Medium' %}bg-info text-dark
                                                    {% elif vuln.severity == 'Low' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ vuln.severity }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            <small>
                                                <strong>Location:</strong> {{ vuln.location }}
                                            </small>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ vuln.id }}">
                                                    Show Details
                                                </button>
                                                <div class="collapse mt-2" id="collapse-{{ vuln.id }}">
                                                    <div class="card card-body">
                                                        <h6>Evidence</h6>
                                                        {% if vuln.proof %}
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ vuln.proof }}</code></pre>
                                                        {% else %}
                                                            <p>No detailed evidence provided.</p>
                                                        {% endif %}
                                                        
                                                        <h6>Recommended Remediation</h6>
                                                        <p>{{ vuln.remediation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Strategic Recommendations -->
                <div class="card mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                        <h4 class="mb-0">Strategic Recommendations</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5>Immediate Actions</h5>
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <i class="fas fa-shield-alt me-2 text-danger"></i>
                                        <strong>Address High-Risk Issues</strong>
                                        <p class="text-muted mb-0 mt-1">Prioritize fixing all critical and high severity issues identified in this report.</p>
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-code me-2 text-warning"></i>
                                        <strong>Review Suspicious Code</strong>
                                        <p class="text-muted mb-0 mt-1">Examine and clean up any obfuscated or suspicious JavaScript code.</p>
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-globe me-2 text-info"></i>
                                        <strong>Check External Connections</strong>
                                        <p class="text-muted mb-0 mt-1">Verify all external domains and connections to ensure they are legitimate.</p>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5>Long-Term Strategy</h5>
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <i class="fas fa-lock me-2 text-primary"></i>
                                        <strong>Implement Content Security Policy</strong>
                                        <p class="text-muted mb-0 mt-1">Add a CSP to restrict resource loading and prevent malicious code execution.</p>
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-check-double me-2 text-success"></i>
                                        <strong>Use Subresource Integrity</strong>
                                        <p class="text-muted mb-0 mt-1">Implement SRI checks for external scripts to prevent tampering.</p>
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-sync me-2 text-secondary"></i>
                                        <strong>Regular Security Scanning</strong>
                                        <p class="text-muted mb-0 mt-1">Schedule periodic malware traffic analysis to maintain a clean environment.</p>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('reports_bp.download_report', report_id=report.id) }}" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download Full Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare data for stage distribution chart
        const stageLabels = ['Traffic Analysis', 'Static Analysis', 'Communication Analysis', 'Dynamic Analysis', 'Selective Dynamic'];
        const stageCounts = [
            {{ stages.traffic_analysis|length }},
            {{ stages.static_analysis|length }},
            {{ stages.communication_analysis|length }},
            {{ stages.dynamic_analysis|length }},
            {{ stages.selective_dynamic|length }}
        ];
        const stageColors = [
            'rgba(13, 202, 240, 0.7)',   // Info (Traffic Analysis)
            'rgba(13, 110, 253, 0.7)',   // Primary (Static Analysis)
            'rgba(255, 193, 7, 0.7)',    // Warning (Communication Analysis)
            'rgba(220, 53, 69, 0.7)',    // Danger (Dynamic Analysis)
            'rgba(25, 135, 84, 0.7)'     // Success (Selective Dynamic)
        ];
        
        // Create stage distribution chart
        const stageCtx = document.getElementById('stageDistributionChart').getContext('2d');
        new Chart(stageCtx, {
            type: 'bar',
            data: {
                labels: stageLabels,
                datasets: [{
                    label: 'Findings by Analysis Stage',
                    data: stageCounts,
                    backgroundColor: stageColors,
                    borderColor: stageColors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                return `${value} ${value === 1 ? 'Finding' : 'Findings'}`;
                            }
                        }
                    }
                }
            }
        });
        
        // Format JSON in pre tags for better readability
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            try {
                const content = codeBlock.textContent;
                if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                    const jsonObj = JSON.parse(content);
                    codeBlock.textContent = JSON.stringify(jsonObj, null, 2);
                }
            } catch (e) {
                // Not valid JSON, leave as is
            }
        });
    });
</script>
{% endblock %}