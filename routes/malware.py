from flask import Blueprint, render_template, request, jsonify, current_app, flash, redirect, url_for, session
import logging
import json
import threading
from modules.malware_traffic_analyzer import MalwareTrafficAnalyzer
from models import Scan, Report, Vulnerability, db
from datetime import datetime

malware_bp = Blueprint('malware_bp', __name__)
logger = logging.getLogger(__name__)

@malware_bp.route('/malware-dashboard')
def malware_dashboard():
    """
    Render the Malware Traffic Analysis dashboard
    """
    # Get available analysis modes and scan depths
    analyzer = MalwareTrafficAnalyzer()
    analysis_modes = analyzer.get_analysis_modes()
    scan_depths = analyzer.get_scan_depths()
    
    # Get past malware analysis scans if any
    malware_scans = Scan.query.filter(Scan.modules_run.like('%malware_traffic_analyzer%')).order_by(Scan.scan_date.desc()).limit(5).all()
    
    return render_template(
        'malware_dashboard.html',
        analysis_modes=analysis_modes,
        scan_depths=scan_depths,
        recent_scans=malware_scans
    )

@malware_bp.route('/malware-analyzer', methods=['GET', 'POST'])
def malware_analyzer():
    """
    Configure and run malware traffic analysis
    """
    analyzer = MalwareTrafficAnalyzer()
    analysis_modes = analyzer.get_analysis_modes()
    scan_depths = analyzer.get_scan_depths()
    
    if request.method == 'POST':
        target_url = request.form.get('target_url')
        analysis_mode = request.form.get('analysis_mode', 'passive')
        scan_depth = request.form.get('scan_depth', 'medium')
        
        # Create a new scan record
        scan = Scan(
            target_url=target_url,
            scan_date=datetime.utcnow(),
            status='pending',
            user_id=session.get('user_id')  # If using authentication
        )
        
        # Set modules
        modules = ['malware_traffic_analyzer']
        scan.set_modules(modules)
        
        # Save scan to database
        db.session.add(scan)
        db.session.commit()
        
        # Create configuration for the analysis
        config = {
            'url': target_url,
            'analysis_mode': analysis_mode,
            'scan_depth': scan_depth
        }
        
        # Start malware analysis in background thread
        thread = threading.Thread(
            target=run_malware_analysis,
            args=(scan.id, config)
        )
        thread.daemon = True
        thread.start()
        
        flash('Malware traffic analysis started. This may take several minutes to complete.', 'info')
        return redirect(url_for('malware_bp.malware_status', scan_id=scan.id))
    
    return render_template(
        'malware_analyzer.html',
        analysis_modes=analysis_modes,
        scan_depths=scan_depths
    )

@malware_bp.route('/malware-status/<int:scan_id>')
def malware_status(scan_id):
    """
    Show status of malware traffic analysis
    """
    scan = Scan.query.get_or_404(scan_id)
    
    return render_template(
        'malware_status.html',
        scan=scan
    )

@malware_bp.route('/api/malware-status/<int:scan_id>')
def malware_status_api(scan_id):
    """
    API endpoint to get malware analysis status
    """
    try:
        scan = Scan.query.get_or_404(scan_id)
        
        # Check if the analysis has a report
        report_data = None
        if scan.report:
            vulnerabilities = scan.report.vulnerabilities.all()
            vuln_count_by_severity = {}
            for vuln in vulnerabilities:
                if vuln.severity not in vuln_count_by_severity:
                    vuln_count_by_severity[vuln.severity] = 0
                vuln_count_by_severity[vuln.severity] += 1
            
            report_data = {
                'id': scan.report.id,
                'title': scan.report.title,
                'created_at': scan.report.created_at.strftime('%Y-%m-%d %H:%M:%S'),
                'vulnerability_counts': vuln_count_by_severity,
                'total_vulnerabilities': len(vulnerabilities)
            }
        
        return jsonify({
            'id': scan.id,
            'target_url': scan.target_url,
            'status': scan.status,
            'scan_date': scan.scan_date.strftime('%Y-%m-%d %H:%M:%S'),
            'report': report_data
        })
    
    except Exception as e:
        logger.error(f"Error checking malware analysis status: {str(e)}")
        return jsonify({'error': str(e)}), 500

@malware_bp.route('/malware-results/<int:report_id>')
def malware_results(report_id):
    """
    Show detailed results of a malware traffic analysis
    """
    report = Report.query.get_or_404(report_id)
    vulnerabilities = report.vulnerabilities.all()
    
    # Group vulnerabilities by analysis stage
    stages = {
        'traffic_analysis': [],
        'static_analysis': [],
        'communication_analysis': [],
        'dynamic_analysis': [],
        'selective_dynamic': []
    }
    
    other_vulnerabilities = []
    
    for vuln in vulnerabilities:
        # Determine stage based on vulnerability type or description
        assigned = False
        for stage in stages:
            if stage.upper() in vuln.type.upper() or stage.upper() in vuln.description.upper():
                stages[stage].append(vuln)
                assigned = True
                break
        
        if not assigned:
            other_vulnerabilities.append(vuln)
    
    return render_template(
        'malware_results.html',
        report=report,
        stages=stages,
        other_vulnerabilities=other_vulnerabilities
    )

@malware_bp.route('/malware-educational')
def malware_educational():
    """
    Educational page about malware traffic analysis
    """
    return render_template(
        'malware_educational.html'
    )

def run_malware_analysis(scan_id, config):
    """
    Background task to run the malware traffic analysis
    """
    from app import app
    
    with app.app_context():
        try:
            # Get scan record
            scan = Scan.query.get(scan_id)
            if not scan:
                logger.error(f"Scan {scan_id} not found")
                return
            
            # Update scan status
            scan.status = 'in_progress'
            db.session.commit()
            
            # Initialize malware traffic analyzer
            analyzer = MalwareTrafficAnalyzer(config)
            
            # Run analysis - use the target URL as a single-item list
            urls = [config.get('url')]
            results = {'malware_traffic_analyzer': analyzer.scan(urls)}
            
            # Create report record
            report = Report(
                title=f"Malware Traffic Analysis for {scan.target_url}",
                summary="Comprehensive analysis of network traffic and resources for potential malware indicators",
                created_at=datetime.utcnow(),
                user_id=scan.user_id
            )
            
            # Save report
            db.session.add(report)
            db.session.flush()  # Get report ID without committing
            
            # Update scan with report ID
            scan.report_id = report.id
            scan.status = 'completed'
            
            # Add vulnerabilities to the report
            for module_name, module_results in results.items():
                for vuln_data in module_results:
                    vulnerability = Vulnerability(
                        report_id=report.id,
                        type=vuln_data['type'],
                        severity=vuln_data['severity'],
                        description=vuln_data['description'],
                        location=vuln_data['location'],
                        proof=vuln_data.get('proof', ''),
                        remediation=vuln_data.get('remediation', '')
                    )
                    db.session.add(vulnerability)
            
            # Commit all changes
            db.session.commit()
            logger.info(f"Malware Traffic Analysis {scan_id} completed successfully")
            
            # Clean up temporary resources
            analyzer.cleanup()
            
        except Exception as e:
            logger.error(f"Error running malware analysis {scan_id}: {str(e)}")
            try:
                # Update scan status to failed
                scan = Scan.query.get(scan_id)
                if scan:
                    scan.status = 'failed'
                    db.session.commit()
            except Exception as commit_error:
                logger.error(f"Error updating scan status: {str(commit_error)}")